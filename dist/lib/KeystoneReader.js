"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.KeystoneReader=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_lodash=_interopRequireDefault(require("lodash")),_stream=require("stream"),_async=_interopRequireDefault(require("async")),_writeOption=require("./writeOption");class KeystoneReader extends _stream.Readable{constructor(a,b){super(),this.openComment=a=>{this.push("/**\n"),a()},this.closeComment=a=>{this.push(" */\n"),a()},this.writeDummyConst=(a,b,c)=>{"class"===b?this.push(`class ${a} {}\n`):"const"==b&&this.push(`const ${a} = {};\n`),c()},this.writeLine=(a,b)=>{this.push(` * ${a}\n`),b()},this.writeLineBreak=a=>{this.push(" *\n"),a()},this.writeMemberData=(a,b)=>_async.default.series([b=>this.writeLine(`@member ${a}`,b),a=>this.writeLine(`@memberof list:${this.key}`,a),b=>this.writeLine(`@alias list:${this.key}.${a}`,b),this.writeLineBreak],b),this.getPath=a=>{const{path:b,options:{default:c,required:d=!1}}=a,e=_lodash.default.isFunction(c)?void 0:c;let f=b;return _lodash.default.isUndefined(e)||(f=f.concat(`=${e}`)),d||(f=`[${f}]`),`${f}`},this.writeField=(a,b,c)=>{const{options:{note:e},type:d}=a;this.writeLine(`\
@prop {${_lodash.default.upperFirst(d)}Field} ${this.getPath(a)}\
${e?` - ${e}`:""}\
`,c)},this.writeDisplay=(a,b,c)=>this.writeLine(`@prop {String} ${b} - ${a}`,c),this.createMember=(a,b,c,d)=>{_async.default.series([this.openComment,b=>this.writeMemberData(a,b),a=>_async.default.eachOfSeries(b,c,a),this.closeComment,b=>this.writeDummyConst(a,"const",b)],d)},this.writeDocConfig=a=>b=>{_lodash.default.isEmpty(a)?b():_async.default.eachOfSeries(a,(a,b,c)=>{const d=_lodash.default.startsWith(b,"@")?b:`@${b}`;this.writeLine(`${d} ${a}`,c)},b)},this.createList=(a,b={},c)=>{_async.default.series([this.openComment,b=>this.writeLine(`@list ${a}`,b),b=>this.writeLine(`@name ${a}`,b),this.writeDocConfig(b),this.closeComment,b=>this.writeDummyConst(a,"class",b)],c)},this.keystone=a,this.key=b,this.list=a.lists[b],this.isReading=!1,this.writeOption=_writeOption.writeOption.bind(this)}_read(){this.isReading||(this.isReading=!0,this.startReading())}startReading(){const a=this.key,b=this.list,c=b.options,{label:d,plural:e,singular:f,jsDoc:g,jsdoc:h}=c,i=(0,_objectWithoutProperties2.default)(c,["label","plural","singular","jsDoc","jsdoc"]),j=_lodash.default.pick(i,["defaultColumns","defaultQuery","defaultSort","hidden","namePath","nocreate","nodelete","noedit","track"]),k={path:b.path,key:a,label:d,plural:e,singular:f};// const ks = this.keystone;
_async.default.series([b=>this.createList(a,g||h,b),a=>this.createMember("Options",j,this.writeOption,a),a=>this.createMember("Fields",b.fields,this.writeField,a),a=>this.createMember("Display",k,this.writeDisplay,a)],a=>{a?this.emit("error",a):this.push(null)})}}exports.KeystoneReader=KeystoneReader;