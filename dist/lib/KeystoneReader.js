"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.KeystoneReader=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_lodash=_interopRequireDefault(require("lodash")),_stream=require("stream"),_async=_interopRequireDefault(require("async")),_writeOption=require("./writeOption");class KeystoneReader extends _stream.Readable{constructor(a,b){super(),this.openComment=a=>{this.push("/**\n"),a()},this.closeComment=a=>{this.push(" */\n"),a()},this.writeDummyConst=(a,b,c)=>{"class"===b?this.push(`class ${a} {}\n`):"const"==b&&this.push(`const ${a} = {};\n`),c()},this.writeLine=(a,b)=>{this.push(` * ${a}\n`),b()},this.writeLineBreak=a=>{this.push(" *\n"),a()},this.writeMemberData=(a,b)=>_async.default.series([b=>this.writeLine(`@member ${a}`,b),a=>this.writeLine(`@memberof list:${this.key}`,a),b=>this.writeLine(`@alias list:${this.key}.${a}`,b),this.writeLineBreak],b),this.getPath=a=>{const{path:b,options:{default:c,required:d=!1}}=a,e=_lodash.default.isFunction(c)?"":c;let f=b;return _lodash.default.isUndefined(e)||(f=f.concat(`=${e}`)),d||(f=`[${f}]`),`${f}`},this.writeField=(a,b,c)=>{const{options:{note:e},type:d}=a;this.writeLine(`\
@prop {${_lodash.default.upperFirst(d)}Field} ${this.getPath(a)}\
${e?` - ${e}`:""}\
`,c)},this.writeDisplay=(a,b,c)=>this.writeLine(`@prop {String} ${b} - ${a}`,c),this.createMember=(a,b,c,d)=>{_async.default.series([this.openComment,b=>this.writeMemberData(a,b),a=>_async.default.eachOfSeries(b,c,a),this.closeComment,b=>this.writeDummyConst(a,"const",b)],d)},this.keystone=a,this.key=b,this.list=a.lists[b],this.isReading=!1,this.writeOption=_writeOption.writeOption.bind(this)}_read(){this.isReading||(this.isReading=!0,this.startReading())}startReading(){const a=this.key,b=this.keystone,c=this.list,d=c.options,{label:e,plural:f,singular:g}=d,h=(0,_objectWithoutProperties2.default)(d,["label","plural","singular"]),i={path:c.path,key:a,label:e,plural:f,singular:g};_async.default.series([b=>{this.push(`/** @list ${a} */\n`),b()},b=>this.writeDummyConst(a,"class",b),a=>this.createMember("Options",h,this.writeOption,a),a=>this.createMember("Fields",c.fields,this.writeField,a),a=>this.createMember("Display",i,this.writeDisplay,a)],a=>{a?this.emit("error",a):this.push(null)})}}exports.KeystoneReader=KeystoneReader;